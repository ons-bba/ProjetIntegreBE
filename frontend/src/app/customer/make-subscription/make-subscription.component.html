<div class="subscription-container">
  <h2>{{ subscriptionId ? 'Edit Subscription' : 'Make a Subscription' }}</h2>

  <form #subscriptionFormNg="ngForm" (ngSubmit)="submitSubscription(subscriptionFormNg)">
    <!-- Plan Selection -->
    <mat-form-field appearance="fill">
      <mat-label>Select Plan</mat-label>
      <mat-select [(ngModel)]="subscriptionForm.planId" name="planId" (selectionChange)="onPlanChange()" required>
        <mat-option *ngFor="let plan of plans" [value]="plan._id">{{ plan.name }}</mat-option>
      </mat-select>
    </mat-form-field>

    <!-- Service Selection -->
    <mat-form-field appearance="fill">
      <mat-label>Select Services</mat-label>
      <mat-select [(ngModel)]="subscriptionForm.serviceIds" name="serviceIds" multiple (selectionChange)="onServiceChange()" required>
        <mat-option *ngFor="let service of services" [value]="service._id">{{ service.name }} ({{ service.price | currency:'TND':'symbol':'1.3-3' }})</mat-option>
      </mat-select>
    </mat-form-field>

    <!-- Start Date Selection -->
    <mat-form-field appearance="fill">
      <mat-label>Start Date</mat-label>
      <input matInput [matDatepicker]="startPicker" [(ngModel)]="subscriptionForm.startDate" name="startDate" [min]="minDate" [matDatepickerFilter]="startDateFilter" (dateChange)="onStartDateChange($event)" required readonly>
      <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
      <mat-datepicker #startPicker></mat-datepicker>
      <mat-icon matSuffix class="clear-icon" (click)="clearStartDate()" *ngIf="subscriptionForm.startDate">clear</mat-icon>
    </mat-form-field>

    <!-- End Date Selection -->
    <mat-form-field appearance="fill">
      <mat-label>End Date</mat-label>
      <input matInput [matDatepicker]="endPicker" [(ngModel)]="subscriptionForm.endDate" name="endDate" [min]="subscriptionForm.startDate" [matDatepickerFilter]="endDateFilter" (dateChange)="onEndDateChange($event)" required readonly>
      <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
      <mat-datepicker #endPicker></mat-datepicker>
      <mat-icon matSuffix class="clear-icon" (click)="clearEndDate()" *ngIf="subscriptionForm.endDate">clear</mat-icon>
    </mat-form-field>

    <!-- Coupon Code Input and Apply Button -->
    <div class="form-group">
      <mat-form-field appearance="fill">
        <mat-label>Coupon Code</mat-label>
        <input matInput [(ngModel)]="subscriptionForm.couponCode" name="couponCode" placeholder="Enter coupon code (optional)">
      </mat-form-field>
      <button mat-raised-button color="primary" type="button" class="apply-coupon-button" (click)="applyCoupon()" [disabled]="isApplyingCoupon || isCouponApplied">
        Apply Coupon
      </button>
      <button mat-raised-button color="warn" type="button" class="remove-coupon-button" (click)="resetCouponState()" *ngIf="isCouponApplied">
        Remove Coupon
      </button>
    </div>

    <!-- Coupon Applied Indicator -->
    <div class="coupon-applied" *ngIf="isCouponApplied">
      <p>Coupon "{{ appliedCouponCode }}" applied! Discount: {{ discountPercentage.toFixed(2) }}% ({{ offerDiscount | currency:'TND':'symbol':'1.3-3' }})</p>
    </div>

    <!-- Total Cost Display -->
    <div>
      <label>Total Amount</label>
      <p>{{ totalCost | currency:'TND':'symbol':'1.3-3' }}</p>
    </div>

    <!-- Form Actions -->
    <div class="actions">
      <button mat-raised-button color="primary" type="submit" [disabled]="isSubmitting || subscriptionFormNg.invalid">Submit Subscription</button>
      <button mat-raised-button color="warn" type="button" (click)="cancel()">Cancel</button>
    </div>
  </form>
</div>